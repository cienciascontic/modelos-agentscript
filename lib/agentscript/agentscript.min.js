!function(){var root,u,_base,__hasProp={}.hasOwnProperty,__indexOf=[].indexOf||function(t){for(var n=0,e=this.length;e>n;n++)if(n in this&&this[n]===t)return n;return-1},__slice=[].slice,__extends=function(t,n){function e(){this.constructor=t}for(var r in n)__hasProp.call(n,r)&&(t[r]=n[r]);return e.prototype=n.prototype,t.prototype=new e,t.__super__=n.prototype,t},__bind=function(t,n){return function(){return t.apply(n,arguments)}};this.ABM={},root=this,function(){var t,n,e,r;for(this.requestAnimFrame=this.requestAnimationFrame||null,this.cancelAnimFrame=this.cancelAnimationFrame||null,r=["ms","moz","webkit","o"],n=0,e=r.length;e>n;n++)t=r[n],this.requestAnimFrame||(this.requestAnimFrame||(this.requestAnimFrame=this[t+"RequestAnimationFrame"]),this.cancelAnimFrame||(this.cancelAnimFrame=this[t+"CancelAnimationFrame"]),this.cancelAnimFrame||(this.cancelAnimFrame=this[t+"CancelRequestAnimationFrame"]));return this.requestAnimFrame||(this.requestAnimFrame=function(t){return this.setTimeout(t,1e3/60)}),this.cancelAnimFrame||(this.cancelAnimFrame=function(t){return this.clearTimeout(t)})}(),(_base=Array.prototype).indexOf||(_base.indexOf=function(t){var n,e;return function(){var r,i,s;for(s=[],n=r=0,i=this.length;i>r;n=++r)e=this[n],s.push(e===t);return s}.call(this)?n:-1}),ABM.util=u={error:function(t){throw new Error(t)},isArray:Array.isArray||function(t){return!(!(t&&t.concat&&t.unshift)||t.callee)},isFunction:function(t){return!!(t&&t.constructor&&t.call&&t.apply)},isString:function(t){return!!(""===t||t&&t.charCodeAt&&t.substr)},randomInt:function(t){return Math.floor(Math.random()*t)},randomInt2:function(t,n){return t+Math.floor(Math.random()*(n-t))},randomNormal:function(t,n){var e,r,i;return null==t&&(t=0),null==n&&(n=1),r=1-Math.random(),i=Math.random(),e=Math.sqrt(-2*Math.log(r))*Math.cos(2*Math.PI*i),e*n+t},randomFloat:function(t){return Math.random()*t},randomFloat2:function(t,n){return t+Math.random()*(n-t)},randomCentered:function(t){return this.randomFloat2(-t/2,t/2)},log10:function(t){return Math.log(t)/Math.LN10},logN:function(t,n){return Math.log(t)/Math.log(n)},mod:function(t,n){return(t%n+n)%n},wrap:function(t,n,e){return n+this.mod(t-n,e-n)},clamp:function(t,n,e){return Math.max(Math.min(t,e),n)},sign:function(t){return 0>t?-1:1},aToFixed:function(t,n){var e,r,i,s;for(null==n&&(n=2),s=[],r=0,i=t.length;i>r;r++)e=t[r],s.push(e.toFixed(n));return s},randomColor:function(t){var n,e;for(null==t&&(t=[]),null!=t.str&&(t.str=null),n=e=0;2>=e;n=++e)t[n]=this.randomInt(256);return t},randomGray:function(t,n,e){var r,i,s;if(null==t&&(t=[]),null==n&&(n=64),null==e&&(e=192),2===arguments.length)return this.randomGray(null,t,n);for(null!=t.str&&(t.str=null),i=this.randomInt2(n,e),r=s=0;2>=s;r=++s)t[r]=i;return t},randomMapColor:function(t,n){return null==t&&(t=[]),null==n&&(n=[0,63,127,191,255]),this.setColor(t,u.oneOf(n),u.oneOf(n),u.oneOf(n))},randomBrightColor:function(t){return null==t&&(t=[]),this.randomMapColor(t,[0,127,255])},setColor:function(t,n,e,r,i){return null!=t.str&&(t.str=null),t[0]=n,t[1]=e,t[2]=r,null!=i&&(t[3]=i),t},scaleColor:function(t,n,e){var r,i,s,o;for(null==e&&(e=[]),null!=e.str&&(e.str=null),r=s=0,o=t.length;o>s;r=++s)i=t[r],e[r]=this.clamp(Math.round(i*n),0,255);return e},colorStr:function(t){var n;return null!=(n=t.str)?n:t.str=3===t.length?"rgb("+t+")":"rgba("+t+")"},colorsEqual:function(t,n){return t.toString()===n.toString()},isLittleEndian:function(){var t,n;return n=new Uint8ClampedArray(4),t=new Uint32Array(n.buffer),t[0]=16909060,4===n[0]},degToRad:function(t){return t*Math.PI/180},radToDeg:function(t){return 180*t/Math.PI},subtractRads:function(t,n){var e,r;return r=t-n,e=Math.PI,-e>=r&&(r+=2*e),r>e&&(r-=2*e),r},ownKeys:function(t){var n,e,r;r=[];for(n in t)__hasProp.call(t,n)&&(e=t[n],r.push(n));return r},ownVarKeys:function(t){var n,e,r;r=[];for(n in t)__hasProp.call(t,n)&&(e=t[n],this.isFunction(e)||r.push(n));return r},any:function(t){return 0!==t.length},empty:function(t){return 0===t.length},clone:function(t){return t.slice(0)},last:function(t){return this.empty(t)&&this.error("last: empty array"),t[t.length-1]},oneOf:function(t){return this.empty(t)&&this.error("oneOf: empty array"),t[this.randomInt(t.length)]},nOf:function(t,n){var e,r;for(n>t.length&&this.error("nOf: n > length"),r=[];r.length<n;)e=this.oneOf(t),__indexOf.call(r,e)<0&&r.push(e);return r},contains:function(t,n){return-1!==t.indexOf(n)},removeItem:function(t,n){var e;return-1!==(e=t.indexOf(n))&&t.splice(e,1),0>e&&this.error("removeItem: item not found"),e},shuffle:function(t){return t.sort(function(){return.5-Math.random()})},minOneOf:function(t,n,e){var r,i,s,o,a,u,h;for(null==e&&(e=!1),this.empty(t)&&this.error("minOneOf: empty array"),s=1/0,i=null,this.isString(n)&&(a=n,n=function(t){return t[a]}),u=0,h=t.length;h>u;u++)r=t[u],(o=n(r))<s&&(s=o,i=r);return e?[i,s]:i},maxOneOf:function(t,n,e){var r,i,s,o,a,u,h;for(null==e&&(e=!1),this.empty(t)&&this.error("maxOneOf: empty array"),s=-1/0,i=null,this.isString(n)&&(a=n,n=function(t){return t[a]}),u=0,h=t.length;h>u;u++)r=t[u],(o=n(r))>s&&(s=o,i=r);return e?[i,s]:i},histOf:function(t,n,e){var r,i,s,o,a,u,h,l,c,p;for(s=[],this.isString(e)&&(a=e,e=function(t){return t[a]}),h=0,c=t.length;c>h;h++)r=t[h],i=Math.floor(e(r)/n),s[i]=null!=(o=s[i])?o+1:1;for(i=l=0,p=s.length;p>l;i=++l)u=s[i],null==u&&(s[i]=0);return s},sortBy:function(t,n){return t.sort(function(t,e){return t[n]-e[n]})},uniq:function(t){var n,e,r;for(n=e=r=t.length-1;e>=1;n=e+=-1)t[n-1]===t[n]&&t.splice(n,1);return t},flatten:function(t){return t.reduce(function(t,n){return t.concat(n)})},aMax:function(t){return t.reduce(function(t,n){return Math.max(t,n)})},aMin:function(t){return t.reduce(function(t,n){return Math.min(t,n)})},aSum:function(t){return t.reduce(function(t,n){return t+n})},aMul:function(t){return t.reduce(function(t,n){return t*n})},aAvg:function(t){return this.aSum(t)/t.length},aPairwise:function(t,n,e){var r,i,s,o,a;for(i=0,a=[],r=s=0,o=t.length;o>s;r=++s)i=t[r],a.push(e(i,n[r]));return a},aPairSum:function(t,n){return this.aPairwise(t,n,function(t,n){return t+n})},aPairDif:function(t,n){return this.aPairwise(t,n,function(t,n){return t-n})},aPairMul:function(t,n){return this.aPairwise(t,n,function(t,n){return t*n})},typedToJS:function(t){var n,e,r,i;for(i=[],e=0,r=t.length;r>e;e++)n=t[e],i.push(n);return i},normalize:function(t,n){var e,r,i,s,o,a;for(null==n&&(n=.999999999),e=this.aMin(t),i=n/(this.aMax(t)-e),a=[],s=0,o=t.length;o>s;s++)r=t[s],a.push((r-e)*i);return a},binarySearch:function(t,n,e){var r,i,s,o;for(null==e&&(e=function(t){return t}),s=0,o=t.length-1,r=Math.floor((s+o)/2);(i=e(t[r]))!==n&&o>s;)i>n&&(o=r-1),n>i&&(s=r+1),r=Math.floor((o+s)/2);return e(t[r])===n?r:-1},radsToward:function(t,n,e,r){var i,s,o;return i=Math.PI,s=e-t,o=r-n,0===s?0>o?3*i/2:o>0?i/2:0:Math.atan(o/s)+(0>s?i:0)},inCone:function(t,n,e,r,i,s,o){var a;return e<this.distance(r,i,s,o)?!1:(a=this.radsToward(r,i,s,o),n/2>=Math.abs(this.subtractRads(t,a)))},distance:function(t,n,e,r){var i,s;return i=t-e,s=n-r,Math.sqrt(i*i+s*s)},sqDistance:function(t,n,e,r){var i,s;return i=t-e,s=n-r,i*i+s*s},torusDistance:function(t,n,e,r,i,s){return Math.sqrt(this.torusSqDistance(t,n,e,r,i,s))},torusSqDistance:function(t,n,e,r,i,s){var o,a,u,h;return o=Math.abs(e-t),u=Math.abs(r-n),a=Math.min(o,i-o),h=Math.min(u,s-u),a*a+h*h},torusWraps:function(t,n,e,r,i,s){var o,a;return o=Math.abs(e-t),a=Math.abs(r-n),o>i-o||a>s-a},torus4Pts:function(t,n,e,r,i,s){var o,a;return o=t>e?e+i:e-i,a=n>r?r+s:r-s,[[e,r],[o,r],[e,a],[o,a]]},torusPt:function(t,n,e,r,i,s){var o,a,u,h;return a=t>e?e+i:e-i,h=n>r?r+s:r-s,o=Math.abs(a-t)<Math.abs(e-t)?a:e,u=Math.abs(h-n)<Math.abs(r-n)?h:r,[o,u]},torusRadsToward:function(t,n,e,r,i,s){var o;return o=this.torusPt(t,n,e,r,i,s),e=o[0],r=o[1],this.radsToward(t,n,e,r)},inTorusCone:function(t,n,e,r,i,s,o,a,u){var h,l,c,p;for(p=this.torus4Pts(r,i,s,o,a,u),l=0,c=p.length;c>l;l++)if(h=p[l],this.inCone(t,n,e,r,i,h[0],h[1]))return!0;return!1},fileIndex:{},importImage:function(t,n){var e;return null!=(e=this.fileIndex[t])||(e=t).width&&e.height?null!=n&&n(e):(e=new Image,null!=n&&(e.onload=function(){return n(e)}),e.src=t,this.fileIndex[t]=e),e},xhrLoadFile:function(t,n,e){var r;return null==n&&(n="text"),null!=(r=this.fileIndex[t])?null!=e&&e(r.response):(r=new XMLHttpRequest,r.open("GET",t,null!=e),r.responseType=n,null!=e&&(r.onload=function(){return e(r.response)}),r.send(),this.fileIndex[t]=r),r},createCanvas:function(t,n){var e;return e=document.createElement("canvas"),e.width=t,e.height=n,e},createCtx:function(t,n,e){var r,i;return null==e&&(e="2d"),r=this.createCanvas(t,n),"2d"===e?r.getContext("2d"):null!=(i=r.getContext("webgl"))?i:r.getContext("experimental-webgl")},createLayer:function(t,n,e,r,i){return null==i&&(i="2d"),i=this.createCtx(n,e,i),i.canvas.setAttribute("style","position:absolute;top:0;left:0;z-index:"+r),document.getElementById(t).appendChild(i.canvas),i},setIdentity:function(t){return t.save(),t.setTransform(1,0,0,1,0,0)},clearCtx:function(t){return null!=t.save?(this.setIdentity(t),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.restore()):(t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT))},fillCtx:function(t,n){return null!=t.fillStyle?(this.setIdentity(t),t.fillStyle=this.colorStr(n),t.fillRect(0,0,t.canvas.width,t.canvas.height),t.restore()):(t.clearColor.apply(t,__slice.call(n).concat([1])),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT))},ctxDrawText:function(t,n,e,r){return null==r&&(r=[0,0,0]),t.fillStyle=this.colorStr(r),t.fillText(n,e[0],e[1])},ctxTextParams:function(t,n,e,r){return null==e&&(e="center"),null==r&&(r="middle"),t.font=n,t.textAlign=e,t.textBaseline=r},ctxLabelParams:function(t,n,e){return t.labelColor=n,t.labelXY=e},imageToCtx:function(t){var n;return n=this.createCtx(t.width,t.height),n.drawImage(t,0,0),n},ctxToImage:function(t,n){var e;return e=new Image,null!=n&&(e.onload=function(){return n(e)}),e.src=t.canvas.toDataURL("image/png")},ctxToImageData:function(t){return t.getImageData(0,0,t.canvas.width,t.canvas.height)},canvasToImage:function(t){return ctxToImage(t.getContext("2d"))},canvasToImageData:function(t){return ctxToImageData(t.getContext("2d"))},imageToCanvas:function(t){return imageToCtx(t).canvas},drawCenteredImage:function(t,n,e,r,i,s,o){return t.translate(r,i),t.rotate(e),t.drawImage(n,-s/2,-o/2)},copyCtx:function(t){var n;return n=this.createCtx(t.canvas.width,t.canvas.height),n.drawImage(t.canvas,0,0),n},resizeCtx:function(t,n,e,r){var i;return null==r&&(r=!1),i=this.copyCtx(t),t.canvas.width=n,t.canvas.height=e,t.drawImage(i.canvas,0,0)}},ABM.shapes=ABM.util.s=function(){var t,n,e,r,i,s,o;return s=function(t,n){var e,r,i,s;for(e=i=0,s=n.length;s>i;e=++i)r=n[e],0===e?t.moveTo(r[0],r[1]):t.lineTo(r[0],r[1]);return null},e=function(t,n,e,r){return t.arc(n,e,r/2,0,2*Math.PI)},t=function(t,n,e,r){return t.arc(n,e,r/2,0,2*Math.PI,!0)},n=function(t,n,e,r,i){return t.scale(1,-1),t.drawImage(i,n-r/2,e-r/2,r,r),t.scale(1,-1)},r=function(t,n,e,r){return t.fillRect(n-r/2,e-r/2,r,r)},i=function(t,n){return t.ctx.save(),t.ctx.scale(1,-1),t.ctx.drawImage(n,t.x,-(t.y+t.bits),t.bits,t.bits),t.ctx.restore()},o=[],{"default":{rotate:!0,draw:function(t){return s(t,[[.5,0],[-.5,-.5],[-.25,0],[-.5,.5]])}},triangle:{rotate:!0,draw:function(t){return s(t,[[.5,0],[-.5,-.4],[-.5,.4]])}},arrow:{rotate:!0,draw:function(t){return s(t,[[.5,0],[0,.5],[0,.2],[-.5,.2],[-.5,-.2],[0,-.2],[0,-.5]])}},bug:{rotate:!0,draw:function(t){return t.strokeStyle=t.fillStyle,t.lineWidth=.05,s(t,[[.4,.225],[.2,0],[.4,-.225]]),t.stroke(),t.beginPath(),e(t,.12,0,.26),e(t,-.05,0,.26),e(t,-.27,0,.4)}},pyramid:{rotate:!1,draw:function(t){return s(t,[[0,.5],[-.433,-.25],[.433,-.25]])}},circle:{shortcut:function(t,n,r,i){return t.beginPath(),e(t,n,r,i),t.closePath(),t.fill()},rotate:!1,draw:function(t){return e(t,0,0,1)}},square:{shortcut:function(t,n,e,i){return r(t,n,e,i)},rotate:!1,draw:function(t){return r(t,0,0,1)}},pentagon:{rotate:!1,draw:function(t){return s(t,[[0,.45],[-.45,.1],[-.3,-.45],[.3,-.45],[.45,.1]])}},ring:{rotate:!1,draw:function(n){return e(n,0,0,1),n.closePath(),t(n,0,0,.6)}},cup:{shortcut:function(t,e,r,i){return n(t,e,r,i,this.img())},rotate:!1,imgCache:null,img:function(){return this.imgCache?this.imageCache:this.imageCache=u.importImage("http://goo.gl/LTIyR")},draw:function(t){return n(t,.5,.5,1,this.img())}},person:{rotate:!1,draw:function(t){return s(t,[[.15,.2],[.3,0],[.125,-.1],[.125,.05],[.1,-.15],[.25,-.5],[.05,-.5],[0,-.25],[-.05,-.5],[-.25,-.5],[-.1,-.15],[-.125,.05],[-.125,-.1],[-.3,0],[-.15,.2]]),t.closePath(),e(t,0,.35,.3)}},names:function(){var t,n,e;e=[];for(t in this)__hasProp.call(this,t)&&(n=this[t],null!=n.rotate&&null!=n.draw&&e.push(t));return e},add:function(t,e,r,i){var s;return s=this[t]=u.isFunction(r)?{rotate:e,draw:r}:{rotate:e,img:r,draw:function(t){return n(t,.5,.5,1,this.img)}},null==s.img||s.rotate||(s.shortcut=function(t,e,r,i){return n(t,e,r,i,this.img)}),null!=i?s.shortcut=i:void 0},poly:s,circ:e,ccirc:t,cimg:n,csq:r,spriteSheets:o,draw:function(t,n,e,r,i,s,o){return null!=n.shortcut?(null==n.img&&(t.fillStyle=u.colorStr(o)),n.shortcut(t,e,r,i)):(t.save(),t.translate(e,r),1!==i&&t.scale(i,i),0!==s&&t.rotate(s),null!=n.img?n.draw(t):(t.fillStyle=u.colorStr(o),t.beginPath(),n.draw(t),t.closePath(),t.fill()),t.restore()),n},drawSprite:function(t,n,e,r,i,s){return 0===s?t.drawImage(n.ctx.canvas,n.x,n.y,n.bits,n.bits,e-i/2,r-i/2,i,i):(t.save(),t.translate(e,r),t.rotate(s),t.drawImage(n.ctx.canvas,n.x,n.y,n.bits,n.bits,-i/2,-i/2,i,i),t.restore()),n},shapeToSprite:function(t,n,e){var r,s,a,h,l,c,p,f,d;return r=Math.ceil(ABM.patches.toBits(e)),c=this[t],l=null!=c.img?t:""+t+"-"+u.colorStr(n),s=o[r],null==s&&(o[r]=s=u.createCtx(10*r,r),s.nextX=0,s.nextY=0,s.index={}),null!=(a=s.index[l])?a:(r*s.nextX===s.canvas.width&&(u.resizeCtx(s,s.canvas.width,s.canvas.height+r),s.nextX=0,s.nextY++),f=r*s.nextX,d=r*s.nextY,p={ctx:s,x:f,y:d,size:e,bits:r,name:t,color:n,index:l},s.index[l]=p,null!=(h=c.img)?0!==h.height?i(p,h):h.onload=function(){return i(p,h)}:(s.save(),s.scale(r,r),s.translate(s.nextX+.5,s.nextY+.5),s.fillStyle=u.colorStr(n),s.beginPath(),c.draw(s),s.closePath(),s.fill(),s.restore()),s.nextX++,p)}}}(),ABM.AgentSet=function(_super){function AgentSet(t,n,e){this.agentClass=t,this.name=n,this.mainSet=e,AgentSet.__super__.constructor.call(this),this.agentClass.prototype.breed=this,this.ownVariables=[],null==this.mainSet&&(this.ID=0)}return __extends(AgentSet,_super),AgentSet.asSet=function(t,n){var e;return null==n&&(n=ABM.AgentSet),t.__proto__=null!=(e=n.prototype)?e:n.constructor.prototype,t},AgentSet.prototype.create=function(){},AgentSet.prototype.add=function(t){return null!=this.mainSet?this.mainSet.add(t):t.id=this.ID++,this.push(t),t},AgentSet.prototype.remove=function(t){var n;return null!=this.mainSet&&this.mainSet.remove(t),0===this.length&&u.error("remove: empty arraySet"),t===this.last()?this[--this.length]=null:(-1!==(n=this.indexOfID(t.id))&&this.splice(n,1),-1===n&&u.error("remove: indexOfID not in list")),this},AgentSet.prototype.setDefault=function(t,n){return"string"!=typeof t&&u.error("setDefault: name is not a string"),this.agentClass.prototype[t]=n},AgentSet.prototype.own=function(){var t,n,e,r,i,s;for(e=1<=arguments.length?__slice.call(arguments,0):[],0!==e.length%2&&u.error("own: odd number of arguments"),s=[],t=r=0,i=e.length;i>r;t=r+=2)n=e[t],this.setDefault(n,e[t+1]),s.push(this.ownVariables.push(n));return s},AgentSet.prototype.uniq=function(){return u.uniq(this)},AgentSet.prototype.withID=function(t){var n;return-1!==(n=this.indexOfID(t))?this[n]:null},AgentSet.prototype.indexOfID=function(t,n){return null==n&&(n=!0),n||this.sortById(),t===this.last().id?this.length-1:u.binarySearch(this,t,function(t){return t.id})},AgentSet.prototype.asSet=function(t){return ABM.AgentSet.asSet(t)},AgentSet.prototype.asOrderedSet=function(t){return this.asSet(t).sortById()},AgentSet.prototype.toString=function(){var t;return"["+function(){var n,e,r;for(r=[],n=0,e=this.length;e>n;n++)t=this[n],r.push(t.toString());return r}.call(this).join(", ")+"]"},AgentSet.prototype.getProp=function(t){var n,e,r,i;for(i=[],e=0,r=this.length;r>e;e++)n=this[e],i.push(n[t]);return i},AgentSet.prototype.getProps=function(t){var n,e,r,i,s;for(u.isString(t)&&(t=t.split(" ")),s=[],r=0,i=this.length;i>r;r++)n=this[r],s.push(function(){var r,i,s;for(s=[],r=0,i=t.length;i>r;r++)e=t[r],s.push(n[e]);return s}());return s},AgentSet.prototype.getPropWith=function(t,n){var e;return this.asSet(function(){var r,i,s;for(s=[],r=0,i=this.length;i>r;r++)e=this[r],e[t]===n&&s.push(e);return s}.call(this))},AgentSet.prototype.setProp=function(t,n){var e,r,i;for(r=0,i=this.length;i>r;r++)e=this[r],e[t]=n;return this},AgentSet.prototype.maxProp=function(t){return Math.max.apply(Math,this.getProp(t))},AgentSet.prototype.minProp=function(t){return Math.min.apply(Math,this.getProp(t))},AgentSet.prototype.shuffle=function(){return u.shuffle(this)},AgentSet.prototype.sortById=function(){return u.sortBy(this,"id")},AgentSet.prototype.clone=function(){return this.asSet(u.clone(this))},AgentSet.prototype.last=function(){return u.last(this)},AgentSet.prototype.any=function(){return u.any(this)},AgentSet.prototype.other=function(t){var n;return this.asSet(function(){var e,r,i;for(i=[],e=0,r=this.length;r>e;e++)n=this[e],n!==t&&i.push(n);return i}.call(this))},AgentSet.prototype.oneOf=function(){return u.oneOf(this)},AgentSet.prototype.nOf=function(t){return this.asSet(u.nOf(this,t))},AgentSet.prototype.minOneOf=function(t,n){return null==n&&(n=!1),u.minOneOf(this,t,n)},AgentSet.prototype.maxOneOf=function(t,n){return null==n&&(n=!1),u.maxOneOf(this,t,n)},AgentSet.prototype.draw=function(t){var n,e,r;for(u.clearCtx(t),e=0,r=this.length;r>e;e++)n=this[e],n.hidden||n.draw(t);return null},AgentSet.prototype.inRadius=function(t,n,e){var r,i,s,o,a,h;return null==e&&(e=!1),i=n*n,a=t.x,h=t.y,ABM.patches.isTorus?(o=ABM.patches.numX,s=ABM.patches.numY,this.asSet(function(){var n,l,c;for(c=[],n=0,l=this.length;l>n;n++)r=this[n],u.torusSqDistance(a,h,r.x,r.y,o,s)<=i&&(e||r!==t)&&c.push(r);return c}.call(this))):this.asSet(function(){var n,s,o;for(o=[],n=0,s=this.length;s>n;n++)r=this[n],u.sqDistance(a,h,r.x,r.y)<=i&&(e||r!==t)&&o.push(r);return o}.call(this))},AgentSet.prototype.inCone=function(t,n,e,r,i){var s,o,a,h,l,c;return null==i&&(i=!1),a=this.inRadius(t,r,i),l=t.x,c=t.y,ABM.patches.isTorus?(h=ABM.patches.numX,o=ABM.patches.numY,this.asSet(function(){var p,f,d;for(d=[],p=0,f=a.length;f>p;p++)s=a[p],(s===t&&i||u.inTorusCone(n,e,r,l,c,s.x,s.y,h,o))&&d.push(s);return d}())):this.asSet(function(){var o,h,p;for(p=[],o=0,h=a.length;h>o;o++)s=a[o],(s===t&&i||u.inCone(n,e,r,l,c,s.x,s.y))&&p.push(s);return p}())},AgentSet.prototype.ask=function(f){var o,_i,_len;for(u.isString(f)&&eval("f=function(o){return "+f+";}"),_i=0,_len=this.length;_len>_i;_i++)o=this[_i],f(o);return this},AgentSet.prototype["with"]=function(f){var o;return u.isString(f)&&eval("f=function(o){return "+f+";}"),this.asSet(function(){var t,n,e;for(e=[],t=0,n=this.length;n>t;t++)o=this[t],f(o)&&e.push(o);return e}.call(this))},AgentSet}(Array),ABM.Patch=function(){function t(t,n){this.x=t,this.y=n}return t.prototype.n=null,t.prototype.n4=null,t.prototype.color=[0,0,0],t.prototype.hidden=!1,t.prototype.label=null,t.prototype.breed=null,t.prototype.toString=function(){return"{id:"+this.id+" xy:"+[this.x,this.y]+" c:"+this.color+"}"},t.prototype.scaleColor=function(t,n){return this.hasOwnProperty("color")||(this.color=u.clone(this.color)),u.scaleColor(t,n,this.color)},t.prototype.draw=function(t){return t.fillStyle=u.colorStr(this.color),t.fillRect(this.x-.5,this.y-.5,1,1),this.drawLabel(t)},t.prototype.drawLabel=function(t){var n,e,r;return null!=this.label?(r=t.labelXY,n=r[0],e=r[1],t.save(),t.translate(this.x,this.y),t.scale(1/ABM.patches.size,-1/ABM.patches.size),u.ctxDrawText(t,this.label,[n,e],t.labelColor),t.restore()):void 0},t.prototype.agentsHere=function(){var t,n;return null!=(n=this.agents)?n:function(){var n,e,r,i;for(r=ABM.agents,i=[],n=0,e=r.length;e>n;n++)t=r[n],t.p===this&&i.push(t);return i}.call(this)},t.prototype.isOnEdge=function(){return this.x===ABM.patches.minX||this.x===ABM.patches.maxX||this.y===ABM.patches.minY||this.y===ABM.patches.maxY},t.prototype.sprout=function(t,n,e){var r=this;return null==t&&(t=1),null==n&&(n=ABM.agents),null==e&&(e=function(){}),n.create(t,function(t){return t.setXY(r.x,r.y),e(t),t})},t}(),ABM.Patches=function(t){function n(){var t,e,r,i,s,o,a,u,h,l,c;n.__super__.constructor.apply(this,arguments),a=ABM.world;for(t in a)__hasProp.call(a,t)&&(e=a[t],this[t]=e);for(i=s=u=this.maxY,h=this.minY;s>=h;i=s+=-1)for(r=o=l=this.minX,c=this.maxX;c>=o;r=o+=1)this.add(new ABM.Patch(r,i));this.hasNeighbors&&this.setNeighbors(),this.setPixels(),this.drawWithPixels=1===this.size}return __extends(n,t),n.prototype.setDefaultColor=function(t){return ABM.Patch.prototype.color=t},n.prototype.cacheAgentsHere=function(){var t,n,e;for(n=0,e=this.length;e>n;n++)t=this[n],t.agents=[];return null},n.prototype.usePixels=function(t){var n;return null==t&&(t=!0),n=ABM.contexts.patches,n.imageSmoothingEnabled=!t,n.mozImageSmoothingEnabled=!t,n.webkitImageSmoothingEnabled=!t,u.setIdentity(n),this.drawWithPixels=t},n.prototype.cacheRect=function(t,n){var e,r,i,s;for(null==n&&(n=!1),s=[],r=0,i=this.length;i>r;r++)e=this[r],e.pRect=this.patchRect(e,t,t,n),e.pRect.radius=t,s.push(e.pRect.meToo=n);return s},n.prototype.setNeighbors=function(){var t,n,e,r;for(r=[],n=0,e=this.length;e>n;n++)t=this[n],t.n=this.patchRect(t,1,1),r.push(t.n4=[t.n[1],t.n[3],t.n[4],t.n[6]]);return r},n.prototype.setPixels=function(){var t;return 1===this.size?this.pixelsCtx=ABM.contexts.patches:(t=document.createElement("canvas"),t.width=this.numX,t.height=this.numY,this.pixelsCtx=t.getContext("2d")),this.pixelsImageData=this.pixelsCtx.getImageData(0,0,this.numX,this.numY),this.pixelsData=this.pixelsImageData.data,this.pixelsData instanceof Uint8Array?(this.pixelsData32=new Uint32Array(this.pixelsData.buffer),this.pixelsAreLittleEndian=u.isLittleEndian()):void 0},n.prototype.draw=function(t){return this.drawWithPixels?this.drawScaledPixels(t):n.__super__.draw.call(this,t)},n.prototype.patchIndex=function(t,n){return t-this.minX+this.numX*(this.maxY-n)},n.prototype.patchXY=function(t,n){return this[this.patchIndex(t,n)]},n.prototype.clamp=function(t,n){return[u.clamp(t,this.minX-.5,this.maxX+.5),u.clamp(n,this.minY-.5,this.maxY+.5)]},n.prototype.wrap=function(t,n){return[u.wrap(t,this.minX-.5,this.maxX+.5),u.wrap(n,this.minY-.5,this.maxY+.5)]},n.prototype.coord=function(t,n){return this.isTorus?this.wrap(t,n):this.clamp(t,n)},n.prototype.patch=function(t,n){var e;return e=this.coord(t,n),t=e[0],n=e[1],t=u.clamp(Math.round(t),this.minX,this.maxX),n=u.clamp(Math.round(n),this.minY,this.maxY),this.patchXY(t,n)},n.prototype.patchAtPixel=function(t,n){return t=Math.floor(t/this.size)+this.minX,n=this.maxY-Math.floor(n/this.size),t=u.clamp(t,this.minX,this.maxX),n=u.clamp(n,this.minY,this.maxY),this.patchXY(t,n)},n.prototype.randomPt=function(){return[u.randomFloat2(this.minX-.5,this.maxX+.5),u.randomFloat2(this.minY-.5,this.maxY+.5)]},n.prototype.toBits=function(t){return t*this.size},n.prototype.fromBits=function(t){return t/this.size},n.prototype.patchRect=function(t,n,e,r){var i,s,o,a,h,l,c,p,f,d;if(null==r&&(r=!1),null!=t.pRect&&t.pRect.radius===n)return t.pRect;for(s=[],a=h=c=t.y-e,p=t.y+e;p>=h;a=h+=1)for(o=l=f=t.x-n,d=t.x+n;d>=l;o=l+=1)this.isTorus||this.minX<=o&&o<=this.maxX&&this.minY<=a&&a<=this.maxY?(this.isTorus&&(o<this.minX&&(o+=this.numX),o>this.maxX&&(o-=this.numX),a<this.minY&&(a+=this.numY),a>this.maxY&&(a-=this.numY)),i=this.patchXY(o,a),null==i&&(u.error("patchRect: x,y out of bounds, see console.log"),console.log("x "+o+" y "+a+" p.x "+t.x+" p.y "+t.y+" dx "+n+" dy "+e))):i=null,(r||t!==i)&&s.push(i);return this.asSet(s)},n.prototype.installDrawing=function(t,n){return null==n&&(n=ABM.contexts.drawing),u.setIdentity(n),n.drawImage(t,0,0,n.canvas.width,n.canvas.height),n.restore()},n.prototype.importDrawing=function(t,n){return u.importImage(t,function(t){var e;return e=ABM.drawing,u.setIdentity(e),e.drawImage(t,0,0,e.canvas.width,e.canvas.height),e.restore(),null!=n?n():void 0})},n.prototype.pixelByteIndex=function(t){return 4*t.id},n.prototype.pixelWordIndex=function(t){return t.id},n.prototype.installColors=function(t){var n,e,r,i,s,o;for(this.pixelsCtx.drawImage(t,0,0,this.numX,this.numY),n=this.pixelsCtx.getImageData(0,0,this.numX,this.numY).data,o=[],i=0,s=this.length;s>i;i++)r=this[i],e=this.pixelByteIndex(r),o.push(r.color=[n[e++],n[e++],n[e]]);return o},n.prototype.importColors=function(t,n){var e=this;return u.importImage(t,function(t){return e.installColors(t),null!=n?n():void 0})},n.prototype.drawScaledPixels=function(t,n){return null==n&&(n=this),null!=this.pixelsData32?this.drawScaledPixels32(t,n):this.drawScaledPixels8(t,n)},n.prototype.drawScaledPixels8=function(t,n){var e,r,i,s,o,a,u,h;for(r=this.pixelsData,a=0,h=n.length;h>a;a++){for(o=n[a],i=this.pixelByteIndex(o),e=o.color,s=u=0;2>=u;s=++u)r[i+s]=e[s];r[i+3]=4===e.length?e[3]:255}return this.pixelsCtx.putImageData(this.pixelsImageData,0,0),1!==this.size?t.drawImage(this.pixelsCtx.canvas,0,0,t.canvas.width,t.canvas.height):void 0},n.prototype.drawScaledPixels32=function(t,n){var e,r,i,s,o,a,u;for(i=this.pixelsData32,a=0,u=n.length;u>a;a++)o=n[a],s=this.pixelWordIndex(o),r=o.color,e=4===r.length?r[3]:255,i[s]=this.pixelsAreLittleEndian?e<<24|r[2]<<16|r[1]<<8|r[0]:r[0]<<24|r[1]<<16|r[2]<<8|e;return this.pixelsCtx.putImageData(this.pixelsImageData,0,0),1!==this.size?t.drawImage(this.pixelsCtx.canvas,0,0,t.canvas.width,t.canvas.height):void 0},n.prototype.diffuse=function(t,n,e){var r,i,s,o,a,u,h,l,c,p,f,d,m,g;if(null==this[0]._diffuseNext)for(u=0,p=this.length;p>u;u++)a=this[u],a._diffuseNext=0;for(h=0,f=this.length;f>h;h++)for(a=this[h],r=a[t]*n,i=r/8,o=a.n.length,a._diffuseNext+=a[t]-r+(8-o)*i,g=a.n,l=0,d=g.length;d>l;l++)s=g[l],s._diffuseNext+=i;for(c=0,m=this.length;m>c;c++)a=this[c],a[t]=a._diffuseNext,a._diffuseNext=0,e&&a.scaleColor(e,a[t]);return null},n}(ABM.AgentSet),ABM.Agent=function(){function t(){this.x=this.y=0,null==this.color&&(this.color=u.randomColor()),null==this.heading&&(this.heading=u.randomFloat(2*Math.PI)),this.p=ABM.patches.patch(this.x,this.y),null!=this.p.agents&&this.p.agents.push(this),this.cacheLinks&&(this.links=[])}return t.prototype.color=null,t.prototype.shape="default",t.prototype.breed=null,t.prototype.hidden=!1,t.prototype.size=1,t.prototype.penDown=!1,t.prototype.penSize=1,t.prototype.heading=null,t.prototype.sprite=null,t.prototype.cacheLinks=!1,t.prototype.changeBreed=function(t){var n=this;return null==this.id&&u.error("changeBreed: not in agentSet"),this.hasOwnProperty("breed")&&u.error("changeBreed: breed illegally set"),this.breed===t&&u.error("changeBreed: breed==newBreed"),this.die(),t.create(1,function(t){return t.setXY(n.x,n.y)})},t.prototype.scaleColor=function(t,n){return this.hasOwnProperty("color")||(this.color=u.clone(this.color)),u.scaleColor(t,n,this.color)},t.prototype.toString=function(){return"{id:"+this.id+" xy:"+u.aToFixed([this.x,this.y])+" c:"+this.color+" h: "+this.heading.toFixed(2)+"}"},t.prototype.setXY=function(t,n){var e,r,i,s,o,a;return this.penDown&&(o=[this.x,this.y],i=o[0],s=o[1]),a=ABM.patches.coord(t,n),this.x=a[0],this.y=a[1],r=this.p,this.p=ABM.patches.patch(this.x,this.y),null!=r.agents&&r!==this.p&&(u.removeItem(r.agents,this),this.p.agents.push(this)),this.penDown?(e=ABM.drawing,e.strokeStyle=u.colorStr(this.color),e.lineWidth=ABM.patches.fromBits(this.penSize),e.beginPath(),e.moveTo(i,s),e.lineTo(t,n),e.stroke()):void 0},t.prototype.moveTo=function(t){return this.setXY(t.x,t.y)},t.prototype.forward=function(t){return this.setXY(this.x+t*Math.cos(this.heading),this.y+t*Math.sin(this.heading))},t.prototype.rotate=function(t){return this.heading=u.wrap(this.heading+t,0,2*Math.PI)},t.prototype.draw=function(t){var n,e;return e=ABM.shapes[this.shape],n=e.rotate?this.heading:0,null!=this.sprite||this.breed.useSprites?(null==this.sprite&&this.setSprite(),ABM.shapes.drawSprite(t,this.sprite,this.x,this.y,this.size,n)):ABM.shapes.draw(t,e,this.x,this.y,this.size,n,this.color)},t.prototype.setSprite=function(t){var n;return null!=(n=t)?(this.sprite=n,this.color=n.color,this.shape=n.shape,this.size=n.size):(null==this.color&&(this.color=u.randomColor),this.sprite=ABM.shapes.shapeToSprite(this.shape,this.color,this.size))},t.prototype.stamp=function(){return this.draw(ABM.drawing)},t.prototype.distanceXY=function(t,n){return ABM.patches.isTorus?u.torusDistance(this.x,this.y,t,n,ABM.patches.numX,ABM.patches.numY):u.distance(this.x,this.y,t,n)},t.prototype.distance=function(t){return this.distanceXY(t.x,t.y)},t.prototype.torusPtXY=function(t,n){return u.torusPt(this.x,this.y,t,n,ABM.patches.numX,ABM.patches.numY)},t.prototype.torusPt=function(t){return this.torusPtXY(t.x,t.y)},t.prototype.face=function(t){return this.heading=this.towards(t)},t.prototype.towardsXY=function(t,n){return ABM.patches.isTorus?u.torusRadsToward(this.x,this.y,t,n,ABM.patches.numX,ABM.patches.numY):u.radsToward(this.x,this.y,t,n)},t.prototype.towards=function(t){return this.towardsXY(t.x,t.y)},t.prototype.die=function(){var t,n,e,r;for(this.breed.remove(this),r=this.myLinks(),n=0,e=r.length;e>n;n++)t=r[n],t.die();return null!=this.p.agents&&u.removeItem(this.p.agents,this),null},t.prototype.hatch=function(t,n,e){var r=this;return null==t&&(t=1),null==n&&(n=ABM.agents),null==e&&(e=function(){}),n.create(t,function(t){var n,i;t.setXY(r.x,r.y);for(n in r)__hasProp.call(r,n)&&(i=r[n],"id"!==n&&(t[n]=i));return e(t),t})},t.prototype.inCone=function(t,n,e,r){return null==r&&(r=!1),t.inCone(this.p,this.heading,n,e,r)},t.prototype.otherEnd=function(t){return t.end1===this?t.end2:t.end1},t.prototype.myLinks=function(){var t,n;return null!=(n=this.links)?n:function(){var n,e,r,i;for(r=ABM.links,i=[],n=0,e=r.length;e>n;n++)t=r[n],(t.end1===this||t.end2===this)&&i.push(t);return i}.call(this)},t.prototype.linkNeighbors=function(){var t,n,e,r,i;for(r=this.myLinks(),i=[],n=0,e=r.length;e>n;n++)t=r[n],i.push(this.otherEnd(t));return i},t.prototype.myInLinks=function(){var t,n,e,r,i;for(r=this.myLinks(),i=[],n=0,e=r.length;e>n;n++)t=r[n],t.end2===this&&i.push(t);return i},t.prototype.inLinkNeighbors=function(){var t,n,e,r,i;for(r=this.myLinks(),i=[],n=0,e=r.length;e>n;n++)t=r[n],t.end2===this&&i.push(t.end1);return i},t.prototype.myOutLinks=function(){var t,n,e,r,i;for(r=this.myLinks(),i=[],n=0,e=r.length;e>n;n++)t=r[n],t.end1===this&&i.push(t);return i},t.prototype.outLinkNeighbors=function(){var t,n,e,r,i;for(r=this.myLinks(),i=[],n=0,e=r.length;e>n;n++)t=r[n],t.end1===this&&i.push(t.end2);return i},t}(),ABM.Agents=function(t){function n(){n.__super__.constructor.apply(this,arguments),this.useSprites=!1}return __extends(n,t),n.prototype.cacheLinks=function(){return ABM.Agent.prototype.cacheLinks=!0},n.prototype.setDefaultColor=function(t){return this.agentClass.prototype.color=t},n.prototype.setDefaultShape=function(t){return this.agentClass.prototype.shape=t},n.prototype.setDefaultSize=function(t){return this.agentClass.prototype.size=t},n.prototype.setDefaultHeading=function(t){return this.agentClass.prototype.heading=t},n.prototype.setDefaultHidden=function(t){return this.agentClass.prototype.hidden=t},n.prototype.setDefaultSprite=function(t){return this.setDefaultColor(t.color),this.setDefaultShape(t.shape),this.setDefaultSize(t.size),this.agentClass.prototype.sprite=t},n.prototype.setDefaultPen=function(t,n){return null==n&&(n=!1),this.agentClass.prototype.penSize=t,this.agentClass.prototype.penDown=n},n.prototype.setUseSprites=function(t){this.useSprites=null!=t?t:!0},n.prototype["in"]=function(t){var n;return this.asSet(function(){var e,r,i;for(i=[],e=0,r=t.length;r>e;e++)n=t[e],n.breed===this&&i.push(n);
return i}.call(this))},n.prototype.create=function(t,n){var e,r,i;for(null==n&&(n=function(){}),i=[],e=r=1;t>=r;e=r+=1)i.push(function(t){return n(t),t}(this.add(new this.agentClass)));return i},n.prototype.clear=function(){for(;this.any();)this.last().die();return null},n.prototype.inPatches=function(t){var n,e,r,i;for(n=[],r=0,i=t.length;i>r;r++)e=t[r],n.push.apply(n,e.agentsHere());return null!=this.mainSet?this["in"](n):this.asSet(n)},n.prototype.inRect=function(t,n,e,r){var i;return null==r&&(r=!1),i=ABM.patches.patchRect(t.p,n,e,!0),i=this.inPatches(i),r||u.removeItem(i,t),i},n.prototype.inCone=function(t,n,e,r,i){var s;return null==i&&(i=!1),s=this.inRect(t,r,r,!0),s.inCone(t,n,e,r,i)},n.prototype.inRadius=function(t,n,e){var r;return null==e&&(e=!1),r=this.inRect(t,n,n,!0),r.inRadius(t,n,e)},n}(ABM.AgentSet),ABM.Link=function(){function t(t,n){this.end1=t,this.end2=n,null!=this.end1.links&&(this.end1.links.push(this),this.end2.links.push(this))}return t.prototype.breed=null,t.prototype.color=[130,130,130],t.prototype.thickness=2,t.prototype.hidden=!1,t.prototype.draw=function(t){var n;return t.save(),t.strokeStyle=u.colorStr(this.color),t.lineWidth=ABM.patches.fromBits(this.thickness),t.beginPath(),ABM.patches.isTorus?(n=this.end1.torusPt(this.end2),t.moveTo(this.end1.x,this.end1.y),t.lineTo.apply(t,n),(n[0]!==this.end2.x||n[1]!==this.end2.y)&&(n=this.end2.torusPt(this.end1),t.moveTo(this.end2.x,this.end2.y),t.lineTo.apply(t,n))):(t.moveTo(this.end1.x,this.end1.y),t.lineTo(this.end2.x,this.end2.y)),t.closePath(),t.stroke(),t.restore()},t.prototype.die=function(){return this.breed.remove(this),null!=this.end1.links&&u.removeItem(this.end1.links,this),null!=this.end2.links&&u.removeItem(this.end2.links,this),null},t.prototype.bothEnds=function(){return[this.end1,this.end2]},t.prototype.length=function(){return this.end1.distance(this.end2)},t.prototype.otherEnd=function(t){return this.end1===t?this.end2:this.end1},t}(),ABM.Links=function(t){function n(){n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n.prototype.setDefaultColor=function(t){return this.agentClass.prototype.color=t},n.prototype.setDefaultThickness=function(t){return this.agentClass.prototype.thickness=t},n.prototype.setDefaultHidden=function(t){return this.agentClass.prototype.hidden=t},n.prototype.create=function(t,n,e){var r,i,s,o;for(null==e&&(e=function(){}),null==n.length&&(n=[n]),o=[],i=0,s=n.length;s>i;i++)r=n[i],o.push(function(t){return e(t),t}(this.add(new this.agentClass(t,r))));return o},n.prototype.clear=function(){for(;this.any();)this.last().die();return null},n.prototype.allEnds=function(){var t,n,e,r;for(n=this.asSet([]),e=0,r=this.length;r>e;e++)t=this[e],n.push(t.end1,t.end2);return n},n.prototype.nodes=function(){return this.allEnds().sortById().uniq()},n.prototype.layoutCircle=function(t,n,e,r){var i,s,o,a,u;for(null==e&&(e=Math.PI/2),null==r&&(r=-1),s=2*Math.PI/t.length,o=a=0,u=t.length;u>a;o=++a)i=t[o],i.setXY(0,0),i.heading=e+r*s*o,i.forward(n);return null},n}(ABM.AgentSet),ABM.Animator=function(){function t(t,n,e){this.model=t,this.rate=null!=n?n:30,this.multiStep=null!=e?e:!1,this.animateDraws=__bind(this.animateDraws,this),this.animateSteps=__bind(this.animateSteps,this),this.reset()}return t.prototype.setRate=function(t,n){return this.rate=t,this.multiStep=null!=n?n:!1,this.resetAnim()},t.prototype.start=function(){return this.animStop?(this.resetAnim(),this.animStop=!1,this.animate()):void 0},t.prototype.resetAnim=function(){return this.startMS=this.now(),this.startTick=this.ticks,this.startDraw=this.draws},t.prototype.stop=function(){return this.animStop=!0,null!=this.animHandle&&cancelAnimFrame(this.animHandle),null!=this.timeoutHandle&&clearTimeout(this.timeoutHandle),null!=this.intervalHandle&&clearInterval(this.intervalHandle),this.animHandle=this.timerHandle=this.intervalHandle=null},t.prototype.reset=function(){return this.stop(),this.ticks=this.draws=0},t.prototype.step=function(){return this.ticks++,this.model.step()},t.prototype.draw=function(){return this.draws++,this.model.draw()},t.prototype.once=function(){return this.step(),this.draw()},t.prototype.now=function(){return("undefined"!=typeof performance&&null!==performance?performance:Date).now()},t.prototype.ms=function(){return this.now()-this.startMS},t.prototype.ticksPerSec=function(){var t;return 0===(t=this.ticks-this.startTick)?0:Math.round(1e3*t/this.ms())},t.prototype.drawsPerSec=function(){var t;return 0===(t=this.draws-this.startDraw)?0:Math.round(1e3*t/this.ms())},t.prototype.toString=function(){return"ticks: "+this.ticks+", draws: "+this.draws+", rate: "+this.rate+" "+this.ticksPerSec()+"/"+this.drawsPerSec()},t.prototype.animateSteps=function(){return this.step(),this.animStop?void 0:this.timeoutHandle=setTimeout(this.animateSteps,10)},t.prototype.animateDraws=function(){return this.drawsPerSec()<=this.rate&&(this.multiStep||this.step(),this.draw()),this.animStop?void 0:this.animHandle=requestAnimFrame(this.animateDraws)},t.prototype.animate=function(){return this.multiStep&&this.animateSteps(),this.animateDraws()},t}(),ABM.Model=function(){function t(t,n,e,r,i,s,o,a){var h,l,c,p;this.div=t,null==o&&(o=!0),null==a&&(a=!0),ABM.model=this,this.setWorld(n,e,r,i,s,o,a),this.contexts=ABM.contexts={},p=this.contextsInit;for(l in p)__hasProp.call(p,l)&&(c=p[l],this.contexts[l]=h=u.createLayer(t,this.world.width,this.world.height,c.z,c.ctx),this.setCtxTransform(h));this.drawing=ABM.drawing=this.contexts.drawing,this.contexts.spotlight.globalCompositeOperation="xor",this.anim=new ABM.Animator(this),this.refreshLinks=this.refreshAgents=this.refreshPatches=!0,this.patches=ABM.patches=new ABM.Patches(ABM.Patch,"patches"),this.agents=ABM.agents=new ABM.Agents(ABM.Agent,"agents"),this.links=ABM.links=new ABM.Links(ABM.Link,"links"),this.setup()}return t.prototype.contextsInit={patches:{z:0,ctx:"2d"},drawing:{z:1,ctx:"2d"},links:{z:2,ctx:"2d"},agents:{z:3,ctx:"2d"},spotlight:{z:4,ctx:"2d"}},t.prototype.reset=function(){var t,n,e;this.anim.reset(),this.patches=ABM.patches=new ABM.Patches(ABM.Patch,"patches"),this.agents=ABM.agents=new ABM.Agents(ABM.Agent,"agents"),this.links=ABM.links=new ABM.Links(ABM.Link,"links"),e=this.contexts;for(t in e)n=e[t],this.setCtxTransform(n);return this.setSpotlight(null),this.contexts.spotlight.globalCompositeOperation="xor",u.s.spriteSheets.length=0},t.prototype.restart=function(){return this.reset(),this.setup(),this.start()},t.prototype.setWorld=function(t,n,e,r,i,s,o){var a,u,h,l;return null==s&&(s=!0),null==o&&(o=!0),u=e-n+1,h=i-r+1,l=u*t,a=h*t,ABM.world=this.world={size:t,minX:n,maxX:e,minY:r,maxY:i,numX:u,numY:h,width:l,height:a,isTorus:s,hasNeighbors:o}},t.prototype.setCtxTransform=function(t){return t.canvas.width=this.world.width,t.canvas.height=this.world.height,t.save(),t.scale(this.world.size,-this.world.size),t.translate(-(this.world.minX-.5),-(this.world.maxY+.5))},t.prototype.setFastPatches=function(){return this.patches.usePixels()},t.prototype.setCacheAgentsHere=function(){return this.patches.cacheAgentsHere()},t.prototype.setCacheMyLinks=function(){return this.agents.cacheLinks()},t.prototype.setCachePatchRects=function(t,n){return null==n&&(n=!1),this.patches.cacheRect(t,n)},t.prototype.setTextParams=function(t,n,e,r){return null==e&&(e="center"),null==r&&(r="middle"),u.ctxTextParams(this.contexts[t.name],n,e,r)},t.prototype.setLabelParams=function(t,n,e){return u.ctxLabelParams(this.contexts[t.name],n,e)},t.prototype.setup=function(){},t.prototype.step=function(){},t.prototype.start=function(){return this.anim.start()},t.prototype.stop=function(){return this.anim.stop()},t.prototype.once=function(){return this.anim.once()},t.prototype.draw=function(){return(this.refreshPatches||1===this.anim.draws)&&this.patches.draw(this.contexts.patches),(this.refreshLinks||1===this.anim.draws)&&this.links.draw(this.contexts.links),(this.refreshAgents||1===this.anim.draws)&&this.agents.draw(this.contexts.agents),null!=this.spotlightAgent?this.drawSpotlight(this.spotlightAgent,this.contexts.spotlight):void 0},t.prototype.setSpotlight=function(t){return this.spotlightAgent=t,null==this.spotlightAgent?u.clearCtx(this.contexts.spotlight):void 0},t.prototype.drawSpotlight=function(t,n){return u.clearCtx(n),u.fillCtx(n,[0,0,0,.6]),n.beginPath(),n.arc(t.x,t.y,this.spotlightRadius||3,0,2*Math.PI,!1),n.fill()},t.prototype.createBreeds=function(t,n,e){var r,i,s,o,a,u,h,l;for(s=[],s.classes={},s.sets={},h=t.split(" "),a=0,u=h.length;u>a;a++)i=h[a],o=r=function(t){function n(){return l=n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n}(n),this[i]=new e(o,i,n.prototype.breed),s.push(this[i]),s.sets[i]=this[i],s.classes[""+i+"Class"]=o;return s},t.prototype.patchBreeds=function(t){return ABM.patchBreeds=this.createBreeds(t,ABM.Patch,ABM.Patches)},t.prototype.agentBreeds=function(t){return ABM.agentBreeds=this.createBreeds(t,ABM.Agent,ABM.Agents)},t.prototype.linkBreeds=function(t){return ABM.linkBreeds=this.createBreeds(t,ABM.Link,ABM.Links)},t.prototype.asSet=function(t){return ABM.AgentSet.asSet(t)},t.prototype.setRootVars=function(){return root.ps=this.patches,root.p0=this.patches[0],root.as=this.agents,root.a0=this.agents[0],root.ls=this.links,root.l0=this.links[0],root.dr=this.drawing,root.u=ABM.util,root.sh=ABM.shapes,root.app=this,root.cx=this.contexts,root.ab=ABM.agentBreeds,root.lb=ABM.linkBreeds,root.an=this.anim,root.wd=ABM.world,root.gl=this.globals,root.root=root,null},t}()}.call(this);